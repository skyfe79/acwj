# 47장: `sizeof`의 부분 집합 구현

실제 C 컴파일러에서 `sizeof()` 연산자는 다음과 같은 경우에 바이트 단위의 크기를 반환한다:

 + 타입 정의
 + 표현식의 타입

현재 우리가 개발 중인 컴파일러 코드를 살펴보니, 위 두 가지 옵션 중 첫 번째 경우에만 `sizeof()`를 사용하고 있다. 따라서 첫 번째 경우만 구현하기로 결정했다. 이렇게 하면 `sizeof()` 내부의 토큰들이 타입 정의라고 가정할 수 있어 구현이 조금 더 쉬워진다.


## 새로운 토큰과 키워드

"sizeof" 키워드와 새로운 토큰인 T_SIZEOF가 필요하다. 평소처럼, `scan.c` 파일의 변경 사항을 살펴보자.

새로운 토큰을 추가할 때는 다음과 같이 업데이트해야 한다:

```c
// 디버깅 목적으로 사용할 토큰 문자열 목록
char *Tstring[] = {
  "EOF", "=", "+=", "-=", "*=", "/=",
  "||", "&&", "|", "^", "&",
  "==", "!=", ",", ">", "<=", ">=", "<<", ">>",
  "+", "-", "*", "/", "++", "--", "~", "!",
  "void", "char", "int", "long",
  "if", "else", "while", "for", "return",
  "struct", "union", "enum", "typedef",
  "extern", "break", "continue", "switch",
  "case", "default", "sizeof",
  "intlit", "strlit", ";", "identifier",
  "{", "}", "(", ")", "[", "]", ",", ".",
  "->", ":"
};
```

처음에 이 작업을 잊어버렸고, 디버깅 중에 "default" 이후의 토큰에 대해 "잘못된" 토큰 설명이 표시되는 것을 발견했다. 이런!


## 파서 변경 사항

`sizeof()` 연산자는 표현식 파싱의 일부다. 이 연산자는 표현식을 받아 새로운 값을 반환한다. 다음과 같은 코드를 작성할 수 있다:

```c
  int x= 43 + sizeof(char);
```

따라서 `sizeof()`를 추가하기 위해 `expr.c` 파일을 수정한다. `sizeof()`는 이항 연산자가 아니며, 접두사나 접미사 연산자도 아니다. 따라서 `sizeof()`를 기본 표현식 파싱의 일부로 추가하는 것이 가장 적절하다.

사실, 사소한 버그를 수정하고 나면 `sizeof()`를 구현하는 데 필요한 새로운 코드의 양은 많지 않다. 아래는 그 코드다:

```c
// 기본 요소를 파싱하고 이를 나타내는 AST 노드를 반환한다.
static struct ASTnode *primary(void) {
  struct ASTnode *n;
  int id;
  int type=0;
  int size, class;
  struct symtable *ctype;

  switch (Token.token) {
  case T_SIZEOF:
    // T_SIZEOF를 건너뛰고 왼쪽 괄호가 있는지 확인한다.
    scan(&Token);
    if (Token.token != T_LPAREN)
      fatal("sizeof 뒤에 왼쪽 괄호가 필요합니다.");
    scan(&Token);

    // 괄호 안의 타입을 가져온다.
    type= parse_stars(parse_type(&ctype, &class));
    // 타입의 크기를 가져온다.
    size= typesize(type, ctype);
    rparen();
    // 크기를 담은 리프 AST 노드를 반환한다.
    return (mkastleaf(A_INTLIT, P_INT, NULL, size));
    ...
  }
  ...
}
```

이미 타입 정의를 파싱하는 `parse_type()` 함수와 뒤따르는 별표를 파싱하는 `parse_stars()` 함수가 있다. 또한 타입의 바이트 수를 반환하는 `typesize()` 함수도 있다. 이제 토큰을 스캔하고, 이 세 함수를 호출한 뒤, 정수 리터럴을 담은 리프 AST 노드를 생성해 반환하기만 하면 된다.

물론 `sizeof()`와 관련된 여러 세부 사항이 있지만, "KISS 원칙"을 따르며 컴파일러가 스스로 컴파일할 수 있을 정도로만 구현한다.


## 새로운 코드 테스트

`tests/input115.c` 파일은 컴파일러의 기본 타입, 포인터, 그리고 구조체에 대한 테스트 셋을 포함한다:

```c
struct foo { int x; char y; long z; }; 
typedef struct foo blah;

int main() {
  printf("%ld\n", sizeof(char));
  printf("%ld\n", sizeof(int));
  printf("%ld\n", sizeof(long));
  printf("%ld\n", sizeof(char *));
  printf("%ld\n", sizeof(blah));
  printf("%ld\n", sizeof(struct symtable));
  printf("%ld\n", sizeof(struct ASTnode));
  return(0);
}
```

현재 컴파일러의 출력 결과는 다음과 같다:

```
1
4
8
8
13
64
48
```

`struct foo` 구조체를 13바이트가 아닌 16바이트로 패딩해야 할지 고민 중이다. 이 문제는 실제로 필요할 때 해결할 예정이다.


 "The only way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get the best way to get best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get the best way to get best way to get best way to get the best way to get best way to get the best way to get best way to get best way to get best way to get the best way to get best way to get best way to get best way to get the best way to get best way to get best way to get best way to get the best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get the best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best way to get best


